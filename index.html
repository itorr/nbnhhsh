<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>èƒ½ä¸èƒ½å¥½å¥½è¯´è¯</title>
	<link rel="stylesheet" href="base.css">
	<link rel="stylesheet" href="nbnhhsh.css">
	<link rel="stylesheet" href="document.css">
</head>
<body>
	<header>
		<h1>èƒ½ä¸èƒ½å¥½å¥½è¯´è¯</h1>
		<p>ğŸ˜©</p>
		<p>æ‹¼éŸ³é¦–å­—æ¯ç¼©å†™é‡Šä¹‰å·¥å…·</p>
	</header>
	<div id="el">
		<textarea v-model="text" placeholder="è¾“å…¥å«æœ‰é¦–å­—æ¯ç¼©å†™çš„æ–‡å­—" @input="nbnhhsh()"></textarea>

		<div class="func-nbnhhsh-box" v-if="show">
			<div class="nbnhhsh-loading" v-if="loading">
				åŠ è½½ä¸­â€¦
			</div>
			<div class="nbnhhsh-tag-list" v-else-if="tags.length">
				<div class="nbnhhsh-tag-item" v-for="tag in tags">
					<h4>{{tag.name}}</h4>
					<div class="nbnhhsh-tran-list" v-if="tag.trans">
						<span class="nbnhhsh-tran-item" v-for="tran in tag.trans">{{tran}}</span>
					</div>
					<div v-else-if="tag.inputting && tag.inputting.length !==0">
						<div class="nbnhhsh-inputting-list">
							<h5>æœ‰å¯èƒ½æ˜¯</h5>
							<span class="nbnhhsh-inputting-item" v-for="input in tag.inputting">{{input}}</span>
						</div>
					</div>
					<div class="nbnhhsh-notran-box" v-else @click.prevent="submitTran(tag.name)">
						å°šæœªå½•å…¥ï¼Œæˆ‘æ¥æäº¤å¯¹åº”æ–‡å­—
					</div>
					<a @click.prevent="submitTran(tag.name)" class="nbnhhsh-add-btn" title="æˆ‘æ¥æäº¤å¯¹åº”æ–‡å­—"></a>
				</div>
			</div>
			<div class="nbnhhsh-loading" v-else>
				æ²¡æœ‰åŒ¹é…åˆ°æ‹¼éŸ³é¦–å­—æ¯ç¼©å†™
			</div>

		</div>
	</div>
	<div class="content-box">
		<p><a href="nbnhhsh.user.js">æ²¹çŒ´è„šæœ¬</a></p>
	</div>

	<script src="https://cdn.bootcss.com/vue/2.6.11/vue.min.js"></script>
	<script>

		let APIURL = 'https://lab.magiconch.com/api/nbnhhsh/';
		let Nbnhhsh = {};

		let guess = (text,onOver)=>{

			if(Nbnhhsh[text]){
				return onOver(Nbnhhsh[text]);
			}
			if(guess.x){
				guess.x.abort();
			}
			app.loading = true;
			guess.x = new XMLHttpRequest();
			guess.x.open('POST',APIURL+'guess');
			guess.x.setRequestHeader('content-type', 'application/json');
			guess.x.withCredentials = true;
			guess.x.onload = ()=>{
				app.loading = false;
				let data = JSON.parse(guess.x.responseText);

				onOver(Nbnhhsh[text] = data);
			};

			guess.x.send(JSON.stringify({text}));
		};
		let _guess = (text,onOver)=>{
			clearTimeout(_guess.t);
			_guess.t=setTimeout(guess.bind(this,text,onOver),300);
		};
		let submitTran = (name)=>{

			let text = prompt('è¾“å…¥ç¼©å†™å¯¹åº”æ–‡å­—','');

			if(!text || !text.trim || !text.trim()){
				return;
			}

			let x = new XMLHttpRequest();
			x.open('POST',APIURL+'translation/'+name);
			x.setRequestHeader('content-type', 'application/json');
			x.withCredentials = true;
			x.onload = ()=>{
				alert('æ„Ÿè°¢å¯¹å¥½å¥½è¯´è¯é¡¹ç›®çš„æ”¯æŒï¼å®¡æ ¸é€šè¿‡åè¿™æ¡å¯¹åº”å°†ä¼šç”Ÿæ•ˆ');
			};
			x.send(JSON.stringify({text}));
		};
		let app = new Vue({
			el,
			data: {
				text:'',
				tags:[],
				loading:false,
				show:false
			},
			methods: {
				submitTran,
				nbnhhsh(){
					let text = this.text;
					app.show = !!text;
					if(text){

						_guess(text,data=>{

							if(data.error){
								app.error = data.error;
							}else{
								app.error = null;
								app.tags = data;
							}
						});
					}
				}
			}
		});
	</script>
</body>
</html>